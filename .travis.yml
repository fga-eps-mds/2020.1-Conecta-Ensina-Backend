sudo: required

language:
  - node_js

node_js:
  - "12.18.1"

services:
  - docker

stages:
  - Lint
  - Tests
  - Push docker image homolog
  - Push docker image prod

before_install:
  - yarn install
  - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
   

jobs:
  include:
    - stage: "Lint"
      name: "Lint"
      script:
        - yarn lint

    - stage: "Tests"
      name: "Tests"
      script:
        - yarn test --coverage
        - ./node_modules/.bin/codecov -t ${CODECOV_TOKEN}

    - stage: "Push docker image homolog"
      name: "Push docker image homolog"
      if: branch = devel
      script:
        # build docker image
        - docker build -t "$DOCKER_USERNAME"/conecta-ensina-backend:homolog .
        # push image to Docker Hub
        - docker push "$DOCKER_USERNAME"/conecta-ensina-backend:homolog
    
    - stage: "Push docker image prod"
      name: "Push docker image prod"
      if: branch = master
      script:
        # build docker image
        - docker build -t "$DOCKER_USERNAME"/conecta-ensina-backend:prod .
        # push image to Docker Hub
        - docker push "$DOCKER_USERNAME"/conecta-ensina-backend:prod
